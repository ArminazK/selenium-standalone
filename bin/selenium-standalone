#!/usr/bin/env node

var minimist = require('minimist');
var which = require('which');
var merge = require('lodash').merge;
var path = require('path');

var selenium = require('../');
var defaultConfig = require('../lib/default-config');

which('java', function javaFound(err, javaPath) {
  if (err) {
    console.error('Could not find `java`, make sure it is installed in your $PATH');
    return;
  }

  var argv = minimist(process.argv.slice(2), {
    string: ['version', 'drivers.chrome.version', 'drivers.ie.version', 'drivers.firefox.version']
  });

  var action = argv._[0];

  if (action !== 'install' && action !== 'start') {
    console.log('Usage: selenium-standalone install or selenium-standalone start');
    return;
  }

  // everything after `selenium-standalone install [options] --` will be in argv._
  var seleniumArgs = argv._.slice(1);

  // build a new map removing `_` and --config from argv
  var options = Object.keys(argv).reduce(function(prev, cur) {
    if ((cur !== '_') && (cur !== 'config')) {
      prev[cur] = argv[cur];
    }

    return prev;
  }, {});

  // If a config file was specified, load it
  var configFromFile = {};
  if (argv.config) {
    try {
      configFromFile = require(
        path.isAbsolute(argv.config) ? argv.config : path.resolve(process.cwd(), argv.config)
      );
      if (typeof configFromFile !== 'object') {
        throw new Error('Config file does not exports an object');
      }
    } catch(err) {
      console.log('Error parsing config file :', err);
      return;
    }
  }

  // Merge default options, command line options and options from config file
  options = merge({}, defaultConfig, options, configFromFile);

  options.seleniumArgs = seleniumArgs;
  options.spawnOptions = {
    stdio: 'inherit'
  };

  options.logger = options.silent ? null : console.log;
  options.javaPath = javaPath;

  actions[action](options);
});

var actions = {
  start: function(options) {
    var killEvents = ['exit', 'SIGTERM', 'SIGINT'];

    selenium.start(options, started);

    function started(err, cp) {
      if (err) {
        throw err;
      }

      console.log('Selenium started');

      killEvents.forEach(register);

      function register(evName) {
        process.on(evName, kill);
      }

      function unregister(evName) {
        process.removeListener(evName, kill);
      }

      function kill() {
        killEvents.forEach(unregister);
        cp.kill('SIGTERM');
      }
    }
  },
  install: function(options) {
    var ProgressBar = require('progress');
    var bar;
    var firstProgress = true;

    options.progressCb = options.silent ? null : progressCb;

    selenium.install(options, installed);

    function installed(err) {
      if (err) {
        throw err;
      }
    }

    function progressCb(total, progress, chunk) {
      if (firstProgress) {
        console.log('');
        console.log('');
        firstProgress = false;
      }

      bar = bar || new ProgressBar(
        'selenium-standalone installation [:bar] :percent :etas', {
        total: total,
        complete: '=',
        incomplete: ' ',
        width: 20
      });

      bar.tick(chunk);
    }
  }
};
